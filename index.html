<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>SAFD Dispatch</title>

<style>
body{
    background:#1b1b1b;
    color:white;
    font-family:Arial;
    text-align:center;
    margin:0;
}

h1{
    background:#c62828;
    padding:20px;
    margin:0;
}

/* LOGIN */
#loginBox{
    background:#111;
    padding:15px;
}

#loginBox input{
    width:200px;
    padding:8px;
    margin:5px;
    border-radius:6px;
    border:none;
}

#loginBox button{
    width:150px;
}

/* GRID */
#fahrzeuge{
    margin-top:20px;
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:20px;
    padding:20px;
    justify-items:center;
}

.fahrzeug{
    background:#2b2b2b;
    border-radius:12px;
    padding:15px;
    width:100%;
    max-width:340px;
    box-shadow:0 0 10px black;
    transition:0.3s;
}

/* STATUS FARBEN */
.status-green{
    border:3px solid #00e676;
    box-shadow:0 0 20px #00e676;
}

.status-blue{
    border:3px solid #2196f3;
    box-shadow:0 0 20px #2196f3;
}

.status-red{
    border:3px solid #ff3d3d;
    box-shadow:0 0 20px red;
    background:#3a1f1f;
}

select,input{
    margin-top:5px;
    padding:5px;
    width:90%;
    border-radius:6px;
    border:none;
    display:block;
    margin-left:auto;
    margin-right:auto;
}

button{
    margin-top:10px;
    padding:8px;
    width:100%;
    background:#c62828;
    color:white;
    border:none;
    border-radius:8px;
    cursor:pointer;
}
button:hover{background:#ff3d3d;}

@media (max-width:900px){
    #fahrzeuge{grid-template-columns: repeat(2, 1fr);}
}
@media (max-width:500px){
    #fahrzeuge{grid-template-columns: 1fr;}
}
</style>
</head>

<body>

<h1>ðŸš’ SAFD Dispatch</h1>

<div id="loginBox">
    <input id="email" placeholder="E-Mail">
    <input id="password" type="password" placeholder="Passwort">
    <button id="loginBtn">Anmelden</button>
    <button id="logoutBtn" style="display:none;">Abmelden</button>
    <div id="user"></div>
</div>

<div id="fahrzeuge">Bitte anmelden...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

/* DEINE ORIGINAL CONFIG WIEDER EINSETZEN */
const firebaseConfig = {
  apiKey: "AIzaSyBTXuWytv3hkmEy2SfSb8Sx2FHAyB4YEHo",
  authDomain: "safd-dispatch.firebaseapp.com",
  projectId: "safd-dispatch",
  storageBucket: "safd-dispatch.firebasestorage.app",
  messagingSenderId: "28484661868",
  appId: "1:28484661868:web:50f82ac5e10635a9aede49"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const liste = document.getElementById("fahrzeuge");

/* LOGIN */
document.getElementById("loginBtn").onclick = async ()=>{
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;

    try{
        await signInWithEmailAndPassword(auth,email,password);
    }catch(error){
        alert("Login fehlgeschlagen: " + error.message);
    }
};

document.getElementById("logoutBtn").onclick = ()=> signOut(auth);

/* AUTH STATE */
onAuthStateChanged(auth, user=>{
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userDiv = document.getElementById("user");

    if(user){
        userDiv.innerHTML="Angemeldet: "+user.email;
        logoutBtn.style.display="inline-block";
        loginBtn.style.display="none";
        ladeLiveFahrzeuge();
    }else{
        userDiv.innerHTML="";
        logoutBtn.style.display="none";
        loginBtn.style.display="inline-block";
        liste.innerHTML="Bitte anmelden...";
    }
});

/* FAHRZEUGE LADEN */
function ladeLiveFahrzeuge(){
onSnapshot(collection(db,"vehicles"),(snapshot)=>{
    liste.innerHTML="";

    snapshot.forEach((fahrzeug)=>{
        const data = fahrzeug.data();
        const crew = Array.isArray(data.crew) ? data.crew : [];

        let statusClass="";
        if(data.status==="Einsatzbereit Ã¼ber Funk" || data.status==="Einsatzbereit auf Wache"){
            statusClass="status-green";
        }
        else if(data.status==="Nicht Einsatzbereit"){
            statusClass="status-blue";
        }
        else if(data.status==="Im Einsatz"){
            statusClass="status-red";
        }

        const div=document.createElement("div");
        div.className="fahrzeug "+statusClass;

        let crewInputs="";
        crew.forEach(name=>{
            crewInputs += `<input class="crewInput" value="${name}" placeholder="Name">`;
        });

        crewInputs += `<input class="crewInput new" placeholder="+ Neuer Name">`;

        div.innerHTML=`
            <h2>${data.name || "Fahrzeug"}</h2>

            <label>Status:</label>
            <select id="status-${fahrzeug.id}">
                <option ${data.status=="Off-Duty"?"selected":""}>Off-Duty</option>
                <option ${data.status=="Einsatzbereit Ã¼ber Funk"?"selected":""}>Einsatzbereit Ã¼ber Funk</option>
                <option ${data.status=="Einsatzbereit auf Wache"?"selected":""}>Einsatzbereit auf Wache</option>
                <option ${data.status=="Im Einsatz"?"selected":""}>Im Einsatz</option>
                <option ${data.status=="Nicht Einsatzbereit"?"selected":""}>Nicht Einsatzbereit</option>
            </select>

            <label>Besatzung:</label>
            <div id="crew-${fahrzeug.id}">${crewInputs}</div>

            <label>Standort (PLZ):</label>
            <input id="location-${fahrzeug.id}" 
                   value="${data.location || ""}" 
                   placeholder="z.B. 20357">

        `;

        liste.appendChild(div);
    });

    document.querySelectorAll(".crewInput").forEach(input=>{
        input.addEventListener("input",autoAddField);
    });
	/* AUTO SAVE STATUS + LOCATION */
snapshot.forEach((fahrzeug)=>{
    const statusSelect = document.getElementById(`status-${fahrzeug.id}`);
    const locationInput = document.getElementById(`location-${fahrzeug.id}`);

    if(statusSelect){
        statusSelect.addEventListener("change", async ()=>{
            await updateDoc(doc(db,"vehicles",fahrzeug.id),{
                status: statusSelect.value
            });
        });
    }

    if(locationInput){
        locationInput.addEventListener("change", async ()=>{
            await updateDoc(doc(db,"vehicles",fahrzeug.id),{
                location: locationInput.value
            });
        });
    }
});
});
}

/* CREW FELDER */
function autoAddField(e){
    const input = e.target;
    const container = input.parentElement;

    if(input.classList.contains("new") && input.value.trim() !== ""){
        input.classList.remove("new");

        const newInput=document.createElement("input");
        newInput.className="crewInput new";
        newInput.placeholder="+ Neuer Name";

        container.appendChild(newInput);
        newInput.addEventListener("input",autoAddField);
    }

    if(input.value.trim()==="" && !input.classList.contains("new")){
        input.remove();
    }
}

/* SPEICHERN */
window.speichern = async function(id){
    const status=document.getElementById(`status-${id}`).value;
    const location=document.getElementById(`location-${id}`).value;
    const inputs=document.querySelectorAll(`#crew-${id} input`);

    let crew=[];
    inputs.forEach(input=>{
        if(input.value.trim()!==""){
            crew.push(input.value.trim());
        }
    });

    await updateDoc(doc(db,"vehicles",id),{
        status:status,
        crew:crew,
        location:location
    });

    alert("Gespeichert!");
}
</script>
</body>
</html>
